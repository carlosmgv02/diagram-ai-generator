# Makefile para Diagram AI Generator

.PHONY: help install dev test lint format clean run-demo run-mcp

help: ## Muestra esta ayuda
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## Instala dependencias y configura el proyecto
	@echo "ğŸš€ Instalando Diagram AI Generator..."
	./install.sh

dev: ## Configura entorno de desarrollo
	@echo "ğŸ”§ Configurando entorno de desarrollo..."
	python -m venv venv
	. venv/bin/activate && pip install -r requirements.txt
	. venv/bin/activate && pip install -e .
	@echo "âœ… Entorno de desarrollo listo"

test: ## Ejecuta tests
	@echo "ğŸ§ª Ejecutando tests..."
	pytest tests/ -v

test-coverage: ## Ejecuta tests con coverage
	@echo "ğŸ“Š Ejecutando tests con coverage..."
	pytest tests/ --cov=diagram_ai_generator --cov-report=html --cov-report=term

lint: ## Ejecuta linting
	@echo "ğŸ” Ejecutando linting..."
	flake8 src/
	mypy src/

format: ## Formatea el cÃ³digo
	@echo "âœ¨ Formateando cÃ³digo..."
	black src/ tests/
	isort src/ tests/

clean: ## Limpia archivos temporales
	@echo "ğŸ§¹ Limpiando archivos temporales..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf build/ dist/ htmlcov/ .coverage
	rm -rf diagrams_output/*.png diagrams_output/*.svg diagrams_output/*.pdf

run-demo: ## Ejecuta el demo
	@echo "ğŸ¨ Ejecutando demo..."
	python demo.py

run-mcp: ## Ejecuta el servidor MCP
	@echo "ğŸ› ï¸  Ejecutando servidor MCP..."
	python -m diagram_ai_generator.src.application.mcp.server

generate-example: ## Genera un diagrama de ejemplo
	@echo "ğŸ“Š Generando diagrama de ejemplo..."
	diagram-ai generate "aplicaciÃ³n web con load balancer, servidores web y base de datos" --title "Ejemplo de Arquitectura"

list-providers: ## Lista proveedores disponibles
	@echo "ğŸ“‹ Listando proveedores..."
	diagram-ai list-providers

search-aws: ## Busca componentes de AWS
	@echo "ğŸ” Buscando componentes de AWS..."
	diagram-ai search "ec2" --provider aws

test-connection: ## Prueba conexiÃ³n con OpenAI
	@echo "ğŸ”Œ Probando conexiÃ³n..."
	diagram-ai test-connection

build: ## Construye el paquete
	@echo "ğŸ“¦ Construyendo paquete..."
	python setup.py sdist bdist_wheel

install-local: ## Instala desde cÃ³digo local
	@echo "ğŸ“¥ Instalando desde cÃ³digo local..."
	pip install -e .

docker-build: ## Construye imagen Docker (futuro)
	@echo "ğŸ³ Docker build no implementado aÃºn"

docs: ## Genera documentaciÃ³n (futuro)
	@echo "ğŸ“š GeneraciÃ³n de docs no implementada aÃºn"

# Comandos de desarrollo rÃ¡pido
quick-test: ## Test rÃ¡pido sin coverage
	pytest tests/ -x -v

quick-lint: ## Lint solo archivos modificados
	@echo "âš¡ Lint rÃ¡pido..."
	black --check src/
	flake8 src/

setup-env: ## Configura variables de entorno para desarrollo
	@echo "âš™ï¸  Configurando variables de entorno..."
	@if [ ! -f .env ]; then cp .env.example .env; echo "ğŸ“ Archivo .env creado. Configura tu API key."; fi

# Comandos de utilidad
show-structure: ## Muestra estructura del proyecto
	@echo "ğŸ“ Estructura del proyecto:"
	tree -I '__pycache__|*.pyc|venv|.git|htmlcov|*.egg-info' .

check-deps: ## Verifica dependencias
	@echo "ğŸ” Verificando dependencias..."
	@command -v python3 >/dev/null 2>&1 || { echo "âŒ Python3 no encontrado"; exit 1; }
	@command -v dot >/dev/null 2>&1 || { echo "âŒ Graphviz no encontrado"; exit 1; }
	@echo "âœ… Dependencias del sistema OK"

init: install setup-env ## InicializaciÃ³n completa del proyecto
	@echo "ğŸ‰ Proyecto inicializado. Ejecuta 'make run-demo' para probar."